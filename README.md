# Djerba

Create reports from metadata and workflow output

## Introduction

Djerba translates cancer bioinformatics workflow outputs and metadata into standard reporting formats.

The current focus of Djerba is producing clinical reports, in the format developed by the Clinical Genome Informatics (CGI) group at [OICR](https://oicr.on.ca).

Djerba is named for an [island](https://en.wikipedia.org/wiki/Djerba) off the coast of North Africa. (The initial letter D is silent, so it is pronounced "jerba".)

## Command-line scripts

### `djerba.py`

This is the main script to run Djerba and generate reports. It has the following modes:

- `configure`: Read the INI config file supplied by the user; gather inputs from file provenance and other sources; write a fully-specified INI
- `extract`: Take a fully-specified INI as input; extract metrics and write to a reporting directory; optionally, write a JSON summary of metrics
- `html`: Input the reporting directory generated by `extract`, and write an HTML report
- `pdf`: Convert the HTML report to PDF
- `all`: Run the complete reporting process, starting with user-supplied INI and finishing with PDF. Intermediate outputs such as HTML are optional.

Run with `--help` for more information.

### `sequenza_gamma_selector.py`

Standalone script to select the gamma parameter for Sequenza output. (If gamma is not supplied to djerba.py, it will be found automatically.)

Run with `--help` for more information.

## Prerequisites

The following OICR [Modulator](https://gitlab.oicr.on.ca/ResearchIT/modulator) environment modules are required:
- `python/3.7`
- `oncokb-annotator/2.0`
- `cbioportal/0.1`
- `rmarkdown/0.1m`

Djerba has a `setup.py` script which will install its source code and Python dependencies. Production releases will be installed as an environment modules in Modulator. Alternatively, install as described under `Installation`.

**TODO**: PDF conversion requires [wkhtmltopdf](https://github.com/JazzCore/python-pdfkit/wiki/Installing-wkhtmltopdf), not yet installed in Modulator

## Testing

- Run unit tests with `src/test/test.py`

## Installation

- Ensure prerequisite modules are loaded and tests pass.
- Ensure an up-to-date version of [pip](https://pypi.org/project/pip/) is available.
- From the repo directory, run `pip install --prefix $INSTALL_DIR .` to install using `setup.py`. This will copy `djerba.py` to the `bin` directory, and relevant modules and data files to the `lib` directory, under the installation path `$INSTALL_DIR`.
- See `pip install --help` for further installation options.

## Development

### Repository Structure

#### Overview

- [src](./src): Production source code
- [src/bin/](./src/bin/): Scripts to run Djerba
- [src/lib/djerba](./src/lib/djerba): Python package for Djerba functions. Includes subdirectories for data files and R scripts.
- [src/test](./src/test): Tests for production code
- [prototypes](./prototypes): Development area for non-production scripts and tests

#### Contents of Djerba package directory

- Top-level python modules:
  - `configure.py`: Discover additional parameters for the user-supplied INI file
  - `main.py`: Main module to run Djerba functions
  - `render.py`: Render output to HTML or PDF
- Python subpackages:
  - `extract`: Contains Python classes to extract metrics from the given INI parameters
  - `util`: Constants and utility functions
- Other subdirectories:
  - `data`: Data files for Djerba Python classes and R scripts
  - `R_markdown`: R markdown script and ancillary files, for generating HTML
  - `R_stats`: R scripts for computing metrics, used by `extract`

### Release Procedure

- Update `CHANGELOG.md`
- Increment the version number in `setup.py`
- Commit (or merge) to the master branch, and tag the release on Github
- Update environment module configuration in [OICR Modulator](https://gitlab.oicr.on.ca/ResearchIT/modulator) to install the newly tagged release

### Development History

- **2019-01 to 2020-09**: The [cbioportal_tools](https://github.com/oicr-gsi/cbioportal_tools) project, also known as Janus, was a precursor to Djerba. This project was intended to produce reporting directories for [cBioPortal](https://cbioportal.org/).
- **2020-09**: The Djerba repository is created to replace `cbioportal_tools`. Its scope includes CGI clinical reporting as well as cBioPortal. Development releases, up to and including 0.0.4, address both output formats.
- **2021-05**: The scope of Djerba changes, to focus exclusively on CGI clinical reports and drop support for cBioPortal. Major overhaul and simplification of code, prior to release 0.0.5. Data processing for cBioPortal remains an option for the future.

## Copyright and License

Copyright (C) 2020, 2021 by Genome Sequence Informatics, Ontario Institute for Cancer Research.

Licensed under the [GPL 3.0 license](https://www.gnu.org/licenses/gpl-3.0.en.html).
